# CLAUDE.md

以下の要件のソフトウェアを作成します。

1. 機能要件

 - 指定したファイルを読み込みます。
 - 段落ごとに文書を分割します。
 - 分割した文書をカードオブジェクトとして管理します。
 - カードオブジェクトは、状態、文書中の位置、分割した文書、を持ちます。
 - カードオブジェクトの状態は、未処理、処理中、処理済みのいずれかです。
 - カードオブジェクトの文書中の位置は、先頭からの連番とします。
 - カードオブジェクトを画面表示します。
 - カードオブジェクトを選択し、状態、文書中の位置、分割した文書をそれぞれ編集可能とします。

2. 非機能要件
 - カードオブジェクトが大量に存在する場合でも、快適に操作できること。

3. 技術スタック
 - electronで作成します。

4. UI/UX要件（追加）
 - ファイル選択：ドラッグ&ドロップまたはファイルダイアログ
 - カード表示：縦スクロール可能なリスト形式
 - 編集UI：インライン編集（ダブルクリックで編集モード）
 - 状態表示：色分けによる視覚的な状態表示
 - 折畳/展開：子カードの表示切替時に0.3秒のアニメーションを付与

5. ファイル形式要件（追加）
 - 対応形式：テキストファイル（.txt, .md）
 - エンコーディング：UTF-8
 - 最大ファイルサイズ：10MB

6. 段落分割仕様（追加）
 - 区切り文字：連続する改行（\n\n）
 - 空行のみの段落は除外
 - 先頭・末尾の空白文字は除去

7. データ永続化（追加）
 - カード状態はメモリ上で管理（セッション単位）
 - 編集内容の自動保存
 - 元ファイルの変更は行わない

8. 性能要件詳細（追加）
 - 最大カード数：10,000件
 - カード表示応答時間：100ms以内
 - 仮想スクロールによる大量データ対応

## 開発コマンド
- `npm install` - 依存関係のインストール
- `npm start` - 開発サーバー起動
- `npm run build` - プロダクションビルド
- `npm run electron` - Electronアプリ起動
- `npm test` - テスト実行

## アーキテクチャ概要
- **Main Process**: Electronのメインプロセス、ファイル操作とウィンドウ管理
- **Renderer Process**: Reactベースの画面表示とユーザー操作
- **Card Manager**: カードオブジェクトの管理とビジネスロジック
- **Text Processor**: ファイル読み込みと段落分割処理
- **Virtual List**: 大量データ表示のための仮想スクロール

## プロジェクト構成
```
src/
  main/           # Electronメインプロセス
  renderer/       # React UIコンポーネント
  models/         # データモデル
  services/       # ビジネスロジック
  utils/          # ユーティリティ関数
```

## 改修時のルール
 - 変更を行った場合は、ドキュメントも併せてメンテナンスする。
 - commitメッセージは日本語でおこなう。


## 機能追加1 ✅ 完了
  [修正]画面上部のフィルター(状態、内容検索)を操作しても、カードがフィルタされない問題を修正する。
  [追加]入力ファイル毎に、json形式でカード状態を保存する。
  [追加]よって新規にファイル読み込みと、jsonファイルを読み込みに対応する。
  [追加]jsonファイルは、手動でも編集可能とし、毎回読み込み時にvalidationチェックを行う。
  [追加]画面下にはステータスログを表示させ、json読み込み時のvalidationチェック結果を表示する。
  [追加]jsonファイルの読み込み開始、validation結果、読み込み結果完了、操作ログをステータスログとして表示する。

### 実装詳細
- **フィルター修正**: AppContextのuseEffectでフィルター変更時に自動更新
- **JSON保存**: SaveDataManagerでバージョン管理・メタデータ付きのJSON形式
- **JSON読み込み**: バリデーション機能付きで、エラー・警告をログ表示
- **ステータスログ**: LogLevel別の色分け表示（INFO/SUCCESS/WARNING/ERROR）
- **操作ログ**: ファイル操作・カード更新・JSON処理の詳細ログ記録
- **UI改善**: ツールバーにJSON保存・読み込みボタンを追加

### 新規コンポーネント
- `SaveDataManager`: JSON保存データの管理
- `StatusLog`: ログ表示コンポーネント
- `SaveData`: 保存データの型定義

## 機能追加2 ✅ 完了
  [修正]JSONファイルを手動編集後、「JSONファイルを開く」とすると、編集したカードが表示されない。表示されるようにする。
  [修正]もしエラーが発生しているのであれば、ステータスログとして表示する。
  [修正]ステータスログが初回のファイル読み込みしか表示されないので、以降の操作も記録できるようにする。
  [修正]ステータスログの領域は広げることができるようにする。
  [修正]画面上部のフィルター(状態、内容検索)が途中で改行される場合があるので、1段目はファイル操作、2段目にフィルタ操作のUI配置とする。

### 実装詳細
- **JSON表示修正**: loadJsonFile後にupdateCardsList()を明示的に呼び出し
- **エラーログ改善**: 既存のエラーハンドリングでステータスログ表示済み
- **継続ログ機能**: アプリ起動時・フィルター操作時のログ記録を追加
- **リサイザー実装**: ドラッグ操作によるステータスログ領域の高さ調整
- **2段階UI**: ファイル操作（1段目）とフィルター操作（2段目）に分離

### UI改善点
- リサイザーハンドルの視覚的フィードバック
- 動的なツールバー高さ調整
- アイコン付きボタンとラベル
- 操作ログの詳細記録

## 機能追加3 ✅ 完了
  [修正]JSONファイルもドラッグ&ドロップで読み込み可能とする。
  [追加]フォントと文字サイズを選べるようにする。
  [追加]更新時刻が、作成時刻と異なる場合は、常に表示する。
  [修正]上部の制御パネルは、ファイルパスは2段目に、３段目にフィルターとする。

### 実装詳細
- **JSON D&D対応**: FileDropZoneでJSONファイル検出とloadJsonFile呼び出し
- **フォント設定**: AppContextに設定管理、Toolbarに選択UI、CardItemに適用
- **更新時刻表示**: 作成時刻と異なる場合は青色・太字で強調表示
- **3段階レイアウト**: 1段目ファイル操作、2段目ファイルパス情報、3段目フィルター＋設定

### 新機能
- **設定管理**: フォントファミリーとサイズをリアルタイム変更可能
- **視覚強化**: 更新されたカードの識別性向上
- **UI改善**: 論理的な3段階構成でより使いやすいツールバー
- **操作ログ**: 設定変更も詳細にログ記録

## 機能追加4 ✅ 完了
  テキストファイルで読み込んだ時点の情報（初期情報）はそのまま保持する。
  情報(テキストデータ)に変更を加えた場合は、初期情報は保持したまま更新情報を保持する。
  更新上は1世代のみであり、更新のたびに上書きする。

### 実装詳細
- **Cardモデル拡張**: originalContent、hasChangesフィールドを追加
- **CardManager機能強化**: createCardFromDataメソッドで復元機能、変更検知ロジック
- **UI表示改善**: 変更済みカードにバッジ表示、初期内容の表示エリア追加
- **JSON形式更新**: バージョン1.1.0で初期情報を含む保存形式、後方互換性保持

### 新機能
- **初期情報保持**: テキスト読み込み時の元コンテンツを permanent に保存
- **変更検知**: コンテンツ編集時の変更状態を自動追跡
- **変更表示**: 変更されたカードを視覚的に識別（青いバッジ）
- **初期内容表示**: 変更済みカードで元の内容を併記表示
- **世代管理**: 1世代のみの変更履歴（更新時は上書き）

## 機能追加5 ✅ 完了
  jsonファイルには以下の時刻を保持して
  ・作成時刻(=初期読み込みの時刻)
  ・更新時刻(読み込んだ情報を最後に更新した時刻)
  ・状態更新時刻(状態を最後に更新した時刻、初期読込時の「未処理」状態の場合は空欄、その後状態を変化させたらその時刻を記録)

### 実装詳細
- **Cardモデル拡張**: statusUpdatedAtフィールド（任意）を追加
- **CardManager強化**: 状態変更時の自動時刻記録、初期状態では未設定
- **UI表示拡張**: 状態更新時刻を緑色で追加表示
- **JSON形式更新**: バージョン1.2.0で状態更新時刻を含む保存形式

### 新機能
- **3種類の時刻管理**: 作成・更新・状態更新の完全な時系列追跡
- **状態変更履歴**: 初期状態から変更した場合のみ時刻記録
- **視覚的時刻表示**: 作成（グレー）、更新（青）、状態更新（緑）の色分け
- **後方互換性**: 古いJSON形式でも正常動作保証

## 機能追加6 ✅ 完了
  cardの縦方向のサイズは、表示内容がすべて入るサイズにする。

### 実装詳細
- **動的高さ調整**: adjustTextareaHeight関数で編集時テキストエリアのリアルタイム高さ調整
- **自動サイズ計算**: scrollHeightを使用してコンテンツ量に応じた最適な高さを計算
- **最小高さ保証**: テキストエリアの最小高さ60pxを維持して操作性確保
- **リアルタイム更新**: 文字入力時のsetTimeoutによるスムーズな高さ変更

### 新機能
- **編集モード自動調整**: テキストエリアがコンテンツ量に応じて自動的にサイズ変更
- **表示モード最適化**: メインコンテンツと初期内容表示が内容に合わせて表示
- **スムーズなUX**: 入力中の高さ変更でちらつきを防止
- **改行対応**: 複数行テキストの完全表示とwordWrap対応

### 修正内容（カードサイズ自動調整の改善）
- **requestAnimationFrame使用**: より正確なタイミングでの高さ計算
- **パディング・ボーダー考慮**: getComputedStyleで正確なサイズ計算
- **フォント変更対応**: フォントサイズ・ファミリー変更時の自動再調整
- **イベントハンドラー強化**: onChange・onInputの両方で高さ調整
- **最大高さ制限**: 400px上限でスクロール表示への切り替え

### 修正内容（カード位置調整の改善）
- **VariableSizeList導入**: FixedSizeListから可変サイズリストに変更
- **動的サイズ計算**: コンテンツ長と変更状態に基づく推定サイズ計算
- **サイズキャッシュ機能**: 計算済みサイズの保存と再利用
- **自動リセット機能**: カード更新時の自動サイズ再計算
- **適切なマージン**: カード間の12px間隔確保
- **ツールバー高さ調整**: 3段構成に対応した150px設定

## 機能追加7 ✅ 完了
- cardオブジェクト操作機能追加
  - cardオブジェクトは順番を自由に移動できるようにする。
  - cardオブジェクトの初期の位置(順番)は覚えておくようにする。
  - cardオブジェクトの順番を変更した場合、変更したcard以降のすべてのcardの順番に影響するため、元番号"1"ならば、変更後を"1.1"のよう表記にしてすべてのカードの順番に影響しないようにする。
  - cardオブジェクトで保持している"position"の情報は、画面表示しない。不要なら削除する。

### 実装詳細
- **Cardモデル拡張**: originalPosition、displayOrderフィールドを追加
- **CardManager機能強化**: moveCard、moveCardToPosition、getDisplayOrderNumberメソッドを実装
- **全カード再計算システム**: 移動時に全カードのdisplayOrderを整数で再計算、安定した順序管理
- **上下移動UI**: CardItemに▲▼ボタンを追加、直感的なカード並び替え操作
- **ドラッグ&ドロップ**: カード番号ラベルのドラッグで順序変更、ファイルドロップとの競合を回避
- **表示順序管理**: displayOrderによる並び替え、「現在位置 (元: 元位置)」形式の表示番号

### 新機能
- **カード並び替え**: 上下矢印ボタンとドラッグ&ドロップでカードの順序を自由に変更可能
- **初期位置記憶**: originalPositionで元の位置を永続保存
- **全カード再計算**: カード移動時に全体の順序を整数で再計算、小数点問題を解決
- **カード番号ドラッグ**: カード番号ラベルのみドラッグ可能、ファイルドロップとの機能競合を回避
- **改行対応サイズ計算**: 改行や長文の折り返しを考慮した正確なカード配置
- **動的サイズ測定**: ResizeObserverによる実際のカードサイズの動的測定
- **ログ記録**: カード移動操作をステータスログに記録
- **position非表示**: displayOrderNumberによる表示で従来のpositionは非表示化

### 修正内容（問題解決）
- **ドラッグ競合解決**: FileDropZoneでカードドラッグとファイルドロップを区別
- **小数点順序廃止**: 全カード再計算方式で安定した順序管理に変更
- **改行サイズ対応**: コンテンツの改行数と文字数を考慮した正確なサイズ計算
- **視覚的フィードバック**: ドラッグ開始・終了時の透明度とカーソル変更
- **カード間隔調整**: カード移動時の全体サイズリセットで正確な配置

## 機能追加8 ✅ 完了
- カード毎の属性情報を保持する。属性に従い表示方法を変える。
- 属性は2種類ある。表示属性と意味属性とする。
- 表示属性は①見出し、②本文、③雑記
- 意味属性は以下のような情報を持つ。
  - 表示属性①の場合：(任意)
  - 表示属性②の場合：(1)本文、(2)図、(3)表、(4)試験、(5)質問、
  - 表示属性③の場合：(任意)
- 属性ごとに、保持する情報を以下に示す。
  - ①："contents", "contents-tag"
  - ②-(1)："contents", , "contents-tag"
  - ②-(2)："contents", , "contents-tag", "figure-id", "figure-data"
  - ②-(3)："contents", , "contents-tag", "table-id", "table-data"
  - ②-(4)："contents", , "contents-tag", "test-id", "test-prereq", "test-step", "test-cons", "test-spec"
  - ②-(5)："contents", , "contents-tag", "qa-id", "question", "answer"
  - ③："contents", "contents-tag"
- 属性ごとに、Cardの表示内容を見直し、Cardの高さ計算もそれに合わせて調整する。
- ファイル読み込みした時点は、すべて②-(1)の属性で読み込む。

### 実装詳細
- **属性モデル拡張**: DisplayAttribute（表示属性）とSemanticAttribute（意味属性）のenumを追加
- **Cardモデル拡張**: 属性フィールドと属性別詳細情報フィールドを追加
- **CardManager強化**: 属性管理機能、属性変更時の不要フィールドクリア機能を実装
- **UI拡張**: CardItemに属性選択UI、属性別詳細情報表示エリアを追加
- **表示色分け**: 表示属性別の背景色設定（見出し：薄黄、本文：薄青、雑記：薄紫）
- **高さ計算調整**: 属性別詳細情報の表示に応じたカード高さの動的計算
- **JSON形式更新**: バージョン1.3.0で属性情報を含む保存形式、後方互換性保持

### 新機能
- **2段階属性システム**: 表示属性（3種類）と意味属性の組み合わせによる柔軟な分類
- **属性別詳細情報**: 図・表・試験・QA情報の専用フィールド管理
- **動的UI表示**: 属性に応じた詳細情報入力・表示エリアの自動切り替え
- **属性連動機能**: 表示属性変更時の意味属性自動調整
- **視覚的分類**: 属性別の背景色による一目での分類判別
- **デフォルト初期化**: 新規ファイル読み込み時は全て②-(1)本文属性で初期化
- **操作ログ**: 属性変更操作の詳細ログ記録

### 更新内容（編集可能化対応）
- **全フィールド編集可能**: contents, contents-tag, figure-id, figure-data, table-id, table-data, test-id, test-prereq, test-step, test-cons, test-spec, qa-id, question, answer をすべてテキストエリア/入力フィールドとして編集可能に変更
- **編集UI改善**: 属性別に分類されたフィールドグループ、プレースホルダーテキスト、適切なフィールドサイズ設定
- **動的高さ計算**: 編集可能エリアのサイズに応じたカード高さの自動計算
- **リアルタイム更新**: フィールド変更時の即座な保存とUI反映
- **視覚的構造**: アイコン付きセクション見出しと明確なフィールド分離

## 機能追加9 ✅ 完了
- Cardリストの管理を、階層管理可能とする。
- Cardは任意の階層レベルとなることができる。
- ただし、サブ階層となる場合は、必ず一つ上の階層（親階層）のCardが存在することとする。
- トップ階層は階層レベル1とし、以降はサブ階層のレベルに応じた階層レベルとなる。
- Cardの画面上の表示は、階層レベルに従い、カード位置がインデントする。
- Cardの右端が画面上はみ出るので、階層レベル3が画面に入るように調整する。(階層レベル4以降は横スクロールで対応する)
- ある階層のCardの表示順番を移動する場合、その階層のCardの全てのサブ階層のCardと一緒に移動となる。つまり、ある階層配下はグルーピングされて移動することとなる。

### 実装詳細
- **Cardモデル拡張**: hierarchyLevel、parentIdフィールドを追加
- **CardManager階層機能**: indentCard、outdentCard、getChildCards、getDescendantCards、moveCardWithDescendantsメソッドを実装
- **視覚的階層表示**: レベルに応じたインデント表示（24px単位）、階層レベル表示
- **階層操作UI**: インデント（→）、アウトデント（←）ボタンを追加、適切な無効化制御
- **横スクロール対応**: 階層レベル4以降でtransformを使用した横スクロール実装
- **JSON保存形式**: バージョン1.4.0で階層情報を含む保存形式、親子関係の整合性バリデーション
- **AppContext統合**: indentCard、outdentCardアクションをコンテキストに追加、undo/redo対応
- **CardList更新**: 階層アクションプロップスをCardItemに渡し、階層変更時の自動サイズリセット

### 新機能
- **階層管理システム**: 完全な親子関係管理とツリー構造操作
- **インデント/アウトデント**: 直感的な階層操作でカードの親子関係を変更
- **視覚的階層表示**: インデントと階層レベル表示による明確な構造把握
- **横スクロール対応**: 深い階層でも画面内で操作可能な設計
- **グループ移動**: 親カードと全子孫カードのグループ一括移動（未実装：通常の上下移動のみ対応）
- **整合性保証**: JSON保存時の親子関係バリデーションとエラーハンドリング

## 機能追加9の追加修正 ✅ 完了
階層移動時の整合性問題を修正：
- 順番N(階層レベル3) と 順番N+1(階層レベル1) の交換時、階層レベル1→3の連続性が崩れる問題
- 階層レベル1の移動時に配下の階層レベル2カードが引き連れられない問題

### 修正実装詳細
- **階層整合性保証**: moveCardWithHierarchyIntegrityメソッドで移動時の階層連続性を自動維持
- **移動先階層決定**: determineTargetHierarchyLevelメソッドで挿入位置の適切な階層レベルを計算
- **子孫カード一括移動**: getCardGroupForMoveメソッドで親カードと全子孫カードをグループ化
- **階層レベル調整**: adjustCardHierarchyメソッドで移動後の階層レベル差分を全子孫に適用
- **既存メソッド置換**: moveCard/moveCardToPositionメソッドを階層整合性保証版に置換

### 解決された問題
- **階層連続性**: 異なる階層レベル間の移動時に適切な階層レベルに自動調整
- **子孫移動**: 親カード移動時に全子孫カードが自動的に引き連れられる
- **parentID整合性**: 階層レベル変更時の親子関係IDの正確な更新
- **レベル1対応**: 階層レベル1への移動時のparentIDクリア処理

## 機能追加9の追加修正2 ✅ 完了
階層移動・変更時の動作を仕様通りに修正：

### 修正された問題
1. **カード移動時の階層適用**:
   - 問題: カードを移動しても移動元の階層のまま移動される
   - 修正: moveCardGroupToPositionで階層調整後、allCards配列も更新してrecalculateDisplayOrderでの上書きを防止

2. **階層変更時の後続カード影響**:
   - 問題: カードの階層変更時に後続のより深い階層カードが影響を受けない
   - 修正: adjustFollowingCardsHierarchyメソッドで後続カードの階層を自動調整

### 新実装機能
- **adjustFollowingCardsHierarchy**: 階層変更時の後続カードへの影響を処理
- **findParentForLevel**: 階層レベル変更時の適切な親カード検索
- **indentCard/outdentCard拡張**: 後続カード調整機能を統合

### 動作仕様
- **移動時階層適用**: カード移動時に移動先の前後カードに基づく適切な階層レベルが自動適用
- **後続カード連動**: 階層変更時に後続のより深い階層カードが階層差分だけ自動調整
- **階層境界認識**: 同じまたはより浅い階層カードで後続調整を自動停止
- **親ID自動設定**: 階層レベル変更時の適切な親カードIDの自動検索・設定

## 機能追加10 ✅ 完了
- Cardのグルーピング機能を追加する。
- Cardは親子関係／兄弟関係を持ち、親子関係のCard群は親Cardのグループに属するという考えとする。
- 以下例(#はカードの"position"とする, Lvは階層レベル)の場合、#1グループに#2～4が属すると考える。また、入れ子構造となるが#2グループに#3が属すると考える。また#1と#5は兄弟関係、#2と#4は兄弟関係である。
- #1(Lv.1)
    ├#2(Lv.2)
    │└#3(Lv.3)
    └#4(Lv.2)
  #5(Lv.1)  
- グループの親カードに対する操作は子カードにも影響し、親カードの階層レベル変更はすべての子カードの階層レベルも同じ階層レベル変更を行う。
- グループの親カードの順番移動は子カードにも影響し、親カードが移動するとすべての子カードも親カードと一緒に移動する。
- 階層レベルを考慮したカード移動については、「機能追加9の追加修正2」で修正した通り、移動先の階層レベルとなるので、親カードの階層レベルが変更となったら、すべての子カードの階層レベルも変更となる。

### 実装詳細
- **グループ管理システム**: 既存の階層システム（hierarchyLevel, parentId）を活用したグループ概念の実装
- **関係性メソッド**: getSiblingCards、getCardGroupInfoメソッドでカード間関係を完全管理
- **グループ操作統合**: indentCard/outdentCardにadjustGroupHierarchy機能を統合
- **グループ移動**: 既存のmoveCardGroupToPositionでグループ一括移動をサポート
- **UI表示強化**: カード番号表示にグループサイズ情報を追加（例：G:3）

### 新実装機能
- **getSiblingCards**: 同じ親・同じ階層レベルの兄弟カードを取得
- **getCardGroupInfo**: カードの完全なグループ情報（親、子、子孫、兄弟、グループサイズ）を取得
- **adjustGroupHierarchy**: 親カード階層変更時の全子孫カードの階層同期調整
- **moveGroupTogether**: 親カード移動時の全子孫カード連動移動（既存機能の明示化）

### グループ操作仕様
- **階層変更連動**: 親カードのインデント/アウトデント時に全子孫カードが同じ階層差分で自動調整
- **移動連動**: 親カード移動時に全子孫カードが親と一緒にグループ移動
- **関係性管理**: 親子関係・兄弟関係の完全な追跡と管理
- **視覚的表示**: グループルートカードにグループサイズ表示（G:n形式）
- **整合性保証**: グループ操作時の階層構造と親子関係の自動維持
