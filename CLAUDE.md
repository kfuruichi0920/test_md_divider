# CLAUDE.md

以下の要件のソフトウェアを作成します。

1. 機能要件

 - 指定したファイルを読み込みます。
 - 段落ごとに文書を分割します。
 - 分割した文書をカードオブジェクトとして管理します。
 - カードオブジェクトは、状態、文書中の位置、分割した文書、を持ちます。
 - カードオブジェクトの状態は、未処理、処理中、処理済みのいずれかです。
 - カードオブジェクトの文書中の位置は、先頭からの連番とします。
 - カードオブジェクトを画面表示します。
 - カードオブジェクトを選択し、状態、文書中の位置、分割した文書をそれぞれ編集可能とします。

2. 非機能要件
 - カードオブジェクトが大量に存在する場合でも、快適に操作できること。

3. 技術スタック
 - electronで作成します。

4. UI/UX要件（追加）
 - ファイル選択：ドラッグ&ドロップまたはファイルダイアログ
 - カード表示：縦スクロール可能なリスト形式
 - 編集UI：インライン編集（ダブルクリックで編集モード）
 - 状態表示：色分けによる視覚的な状態表示

5. ファイル形式要件（追加）
 - 対応形式：テキストファイル（.txt, .md）
 - エンコーディング：UTF-8
 - 最大ファイルサイズ：10MB

6. 段落分割仕様（追加）
 - 区切り文字：連続する改行（\n\n）
 - 空行のみの段落は除外
 - 先頭・末尾の空白文字は除去

7. データ永続化（追加）
 - カード状態はメモリ上で管理（セッション単位）
 - 編集内容の自動保存
 - 元ファイルの変更は行わない

8. 性能要件詳細（追加）
 - 最大カード数：10,000件
 - カード表示応答時間：100ms以内
 - 仮想スクロールによる大量データ対応

## 開発コマンド
- `npm install` - 依存関係のインストール
- `npm start` - 開発サーバー起動
- `npm run build` - プロダクションビルド
- `npm run electron` - Electronアプリ起動
- `npm test` - テスト実行

## アーキテクチャ概要
- **Main Process**: Electronのメインプロセス、ファイル操作とウィンドウ管理
- **Renderer Process**: Reactベースの画面表示とユーザー操作
- **Card Manager**: カードオブジェクトの管理とビジネスロジック
- **Text Processor**: ファイル読み込みと段落分割処理
- **Virtual List**: 大量データ表示のための仮想スクロール

## プロジェクト構成
```
src/
  main/           # Electronメインプロセス
  renderer/       # React UIコンポーネント
  models/         # データモデル
  services/       # ビジネスロジック
  utils/          # ユーティリティ関数
```

## 改修時のルール
 - 変更を行った場合は、ドキュメントも併せてメンテナンスする。
 - commitメッセージは日本語でおこなう。


## 機能追加1 ✅ 完了
  [修正]画面上部のフィルター(状態、内容検索)を操作しても、カードがフィルタされない問題を修正する。
  [追加]入力ファイル毎に、json形式でカード状態を保存する。
  [追加]よって新規にファイル読み込みと、jsonファイルを読み込みに対応する。
  [追加]jsonファイルは、手動でも編集可能とし、毎回読み込み時にvalidationチェックを行う。
  [追加]画面下にはステータスログを表示させ、json読み込み時のvalidationチェック結果を表示する。
  [追加]jsonファイルの読み込み開始、validation結果、読み込み結果完了、操作ログをステータスログとして表示する。

### 実装詳細
- **フィルター修正**: AppContextのuseEffectでフィルター変更時に自動更新
- **JSON保存**: SaveDataManagerでバージョン管理・メタデータ付きのJSON形式
- **JSON読み込み**: バリデーション機能付きで、エラー・警告をログ表示
- **ステータスログ**: LogLevel別の色分け表示（INFO/SUCCESS/WARNING/ERROR）
- **操作ログ**: ファイル操作・カード更新・JSON処理の詳細ログ記録
- **UI改善**: ツールバーにJSON保存・読み込みボタンを追加

### 新規コンポーネント
- `SaveDataManager`: JSON保存データの管理
- `StatusLog`: ログ表示コンポーネント
- `SaveData`: 保存データの型定義

## 機能追加2 ✅ 完了
  [修正]JSONファイルを手動編集後、「JSONファイルを開く」とすると、編集したカードが表示されない。表示されるようにする。
  [修正]もしエラーが発生しているのであれば、ステータスログとして表示する。
  [修正]ステータスログが初回のファイル読み込みしか表示されないので、以降の操作も記録できるようにする。
  [修正]ステータスログの領域は広げることができるようにする。
  [修正]画面上部のフィルター(状態、内容検索)が途中で改行される場合があるので、1段目はファイル操作、2段目にフィルタ操作のUI配置とする。

### 実装詳細
- **JSON表示修正**: loadJsonFile後にupdateCardsList()を明示的に呼び出し
- **エラーログ改善**: 既存のエラーハンドリングでステータスログ表示済み
- **継続ログ機能**: アプリ起動時・フィルター操作時のログ記録を追加
- **リサイザー実装**: ドラッグ操作によるステータスログ領域の高さ調整
- **2段階UI**: ファイル操作（1段目）とフィルター操作（2段目）に分離

### UI改善点
- リサイザーハンドルの視覚的フィードバック
- 動的なツールバー高さ調整
- アイコン付きボタンとラベル
- 操作ログの詳細記録

## 機能追加3 ✅ 完了
  [修正]JSONファイルもドラッグ&ドロップで読み込み可能とする。
  [追加]フォントと文字サイズを選べるようにする。
  [追加]更新時刻が、作成時刻と異なる場合は、常に表示する。
  [修正]上部の制御パネルは、ファイルパスは2段目に、３段目にフィルターとする。

### 実装詳細
- **JSON D&D対応**: FileDropZoneでJSONファイル検出とloadJsonFile呼び出し
- **フォント設定**: AppContextに設定管理、Toolbarに選択UI、CardItemに適用
- **更新時刻表示**: 作成時刻と異なる場合は青色・太字で強調表示
- **3段階レイアウト**: 1段目ファイル操作、2段目ファイルパス情報、3段目フィルター＋設定

### 新機能
- **設定管理**: フォントファミリーとサイズをリアルタイム変更可能
- **視覚強化**: 更新されたカードの識別性向上
- **UI改善**: 論理的な3段階構成でより使いやすいツールバー
- **操作ログ**: 設定変更も詳細にログ記録

## 機能追加4 ✅ 完了
  テキストファイルで読み込んだ時点の情報（初期情報）はそのまま保持する。
  情報(テキストデータ)に変更を加えた場合は、初期情報は保持したまま更新情報を保持する。
  更新上は1世代のみであり、更新のたびに上書きする。

### 実装詳細
- **Cardモデル拡張**: originalContent、hasChangesフィールドを追加
- **CardManager機能強化**: createCardFromDataメソッドで復元機能、変更検知ロジック
- **UI表示改善**: 変更済みカードにバッジ表示、初期内容の表示エリア追加
- **JSON形式更新**: バージョン1.1.0で初期情報を含む保存形式、後方互換性保持

### 新機能
- **初期情報保持**: テキスト読み込み時の元コンテンツを permanent に保存
- **変更検知**: コンテンツ編集時の変更状態を自動追跡
- **変更表示**: 変更されたカードを視覚的に識別（青いバッジ）
- **初期内容表示**: 変更済みカードで元の内容を併記表示
- **世代管理**: 1世代のみの変更履歴（更新時は上書き）

## 機能追加5 ✅ 完了
  jsonファイルには以下の時刻を保持して
  ・作成時刻(=初期読み込みの時刻)
  ・更新時刻(読み込んだ情報を最後に更新した時刻)
  ・状態更新時刻(状態を最後に更新した時刻、初期読込時の「未処理」状態の場合は空欄、その後状態を変化させたらその時刻を記録)

### 実装詳細
- **Cardモデル拡張**: statusUpdatedAtフィールド（任意）を追加
- **CardManager強化**: 状態変更時の自動時刻記録、初期状態では未設定
- **UI表示拡張**: 状態更新時刻を緑色で追加表示
- **JSON形式更新**: バージョン1.2.0で状態更新時刻を含む保存形式

### 新機能
- **3種類の時刻管理**: 作成・更新・状態更新の完全な時系列追跡
- **状態変更履歴**: 初期状態から変更した場合のみ時刻記録
- **視覚的時刻表示**: 作成（グレー）、更新（青）、状態更新（緑）の色分け
- **後方互換性**: 古いJSON形式でも正常動作保証

## 機能追加6 ✅ 完了
  cardの縦方向のサイズは、表示内容がすべて入るサイズにする。

### 実装詳細
- **動的高さ調整**: adjustTextareaHeight関数で編集時テキストエリアのリアルタイム高さ調整
- **自動サイズ計算**: scrollHeightを使用してコンテンツ量に応じた最適な高さを計算
- **最小高さ保証**: テキストエリアの最小高さ60pxを維持して操作性確保
- **リアルタイム更新**: 文字入力時のsetTimeoutによるスムーズな高さ変更

### 新機能
- **編集モード自動調整**: テキストエリアがコンテンツ量に応じて自動的にサイズ変更
- **表示モード最適化**: メインコンテンツと初期内容表示が内容に合わせて表示
- **スムーズなUX**: 入力中の高さ変更でちらつきを防止
- **改行対応**: 複数行テキストの完全表示とwordWrap対応

### 修正内容（カードサイズ自動調整の改善）
- **requestAnimationFrame使用**: より正確なタイミングでの高さ計算
- **パディング・ボーダー考慮**: getComputedStyleで正確なサイズ計算
- **フォント変更対応**: フォントサイズ・ファミリー変更時の自動再調整
- **イベントハンドラー強化**: onChange・onInputの両方で高さ調整
- **最大高さ制限**: 400px上限でスクロール表示への切り替え

### 修正内容（カード位置調整の改善）
- **VariableSizeList導入**: FixedSizeListから可変サイズリストに変更
- **動的サイズ計算**: コンテンツ長と変更状態に基づく推定サイズ計算
- **サイズキャッシュ機能**: 計算済みサイズの保存と再利用
- **自動リセット機能**: カード更新時の自動サイズ再計算
- **適切なマージン**: カード間の12px間隔確保
- **ツールバー高さ調整**: 3段構成に対応した150px設定
